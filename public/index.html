<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Chat</title>
</head>

<style>
  #chatMessages {
    list-style-type: none;
    padding: 0;
  }

  #chatMessages li {
    margin: 5px 0;
    padding: 10px;
    background-color: #f1f1f1;
    border-radius: 8px;
  }
</style>

<body>
  <div id="userList"></div>
  <input type="text" id="nicknameInput" placeholder="Your Nickname">
  <button onclick="applyNickname()">Apply</button>
  <input type="text" id="messageInput" placeholder="Type a message" disabled>
  <button onclick="sendMessage()" disabled>Send</button>
  <ul id="chatMessages"></ul>

  <script>
    const socket = new WebSocket('ws://218.38.65.83:3000/socket');
    let nickname = '';

    function applyNickname() {
      const nicknameInput = document.getElementById('nicknameInput');
      nickname = nicknameInput.value;
      nicknameInput.disabled = true;
      document.getElementById('messageInput').disabled = false;
      document.querySelector('button[onclick="sendMessage()"]').disabled = false;

      // 클라이언트에서 서버로 닉네임 전송
      socket.send(JSON.stringify({ event: 'setNickname', nickname }));
    }

    socket.addEventListener('message', async (event) => {
      try {
        const chatMessages = document.getElementById('chatMessages');
        const li = document.createElement('li');

        if (typeof event.data === 'string') {
          const parsedMessage = JSON.parse(event.data);

          if (parsedMessage.event === 'userJoined' && parsedMessage.userList) {
            li.textContent = `${parsedMessage.nickname} has joined the chat.`;
            updateUserList(parsedMessage.userList);
          } else {
            li.textContent = `${parsedMessage.nickname}: ${parsedMessage.content}`;
          }
        } else if (event.data instanceof Blob) {
          const textMessage = await event.data.text();
          const parsedMessage = JSON.parse(textMessage);

          if (parsedMessage.event === 'userJoined' && parsedMessage.userList) {
            li.textContent = `${parsedMessage.nickname} has joined the chat.`;
            updateUserList(parsedMessage.userList);
          } else {
            li.textContent = `${parsedMessage.nickname}: ${parsedMessage.content}`;
          }
        }

        chatMessages.appendChild(li);
      } catch (error) {
        console.error('Error handling WebSocket message:', error);
      }
    });

    function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value;

    // 클라이언트에서 서버로 메시지 전송
    socket.send(JSON.stringify({
      event: 'sendMessage',
      content: message
    }));

    messageInput.value = '';
  }

    function updateUserList(userList) {
      const userListContainer = document.getElementById('userList');
      userListContainer.innerHTML = '<strong>Users:</strong>';

      userList.forEach((username) => {
        const userItem = document.createElement('div');
        userItem.textContent = username;
        userListContainer.appendChild(userItem);
      });
    }
  </script>
</body>
</html>
